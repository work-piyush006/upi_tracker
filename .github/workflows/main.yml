name: Build Expense Tracker APK

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Setup Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.3"

      # 3. Create Android folder
      - name: Create Android folder
        run: mkdir -p android/app/src/main

      # 3a. Replace App Icon with assets/logo.png
      - name: Replace App Icon
        run: |
          ICON_SRC="assets/logo.png"
          for DIR in android/app/src/main/res/mipmap-*; do
            cp $ICON_SRC $DIR/ic_launcher.png
          done

      # 4. Generate local.properties
      - name: Generate local.properties
        run: echo "sdk.dir=$ANDROID_SDK_ROOT" > android/local.properties

      # 5. Patch root build.gradle
      - name: Patch root build.gradle
        run: |
          cat > android/build.gradle <<'EOF'
          buildscript {
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath 'com.android.tools.build:gradle:8.5.0'
                  classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.24"
              }
          }
          allprojects {
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.buildDir = "../build"
          subprojects {
              project.buildDir = "${rootProject.buildDir}/${project.name}"
          }
          EOF

      # 6. Replace app/build.gradle
      - name: Replace app/build.gradle
        run: |
          mkdir -p android/app
          cat > android/app/build.gradle <<'EOF'
          plugins {
              id "com.android.application"
              id "org.jetbrains.kotlin.android"
              id "dev.flutter.flutter-gradle-plugin"
          }

          android {
              namespace "com.expensetracker.app"
              compileSdk 34

              defaultConfig {
                  applicationId "com.expensetracker.app"
                  minSdk 21
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }

              buildTypes {
                  release {
                      minifyEnabled false
                      shrinkResources false
                  }
              }
          }

          flutter {
              source '../..'
          }
          EOF

      # 7. Replace AndroidManifest.xml
      - name: Replace AndroidManifest.xml
        run: |
          mkdir -p android/app/src/main
          cat > android/app/src/main/AndroidManifest.xml <<'EOF'
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="com.expensetracker.app">
              <application
                  android:label="UPI Tracker"
                  android:name="${applicationName}"
                  android:icon="@mipmap/ic_launcher">
                  <activity
                      android:name=".MainActivity"
                      android:exported="true"
                      android:launchMode="singleTop"
                      android:theme="@style/LaunchTheme"
                      android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"
                      android:hardwareAccelerated="true"
                      android:windowSoftInputMode="adjustResize">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN"/>
                          <category android:name="android.intent.category.LAUNCHER"/>
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

      # 8. Fix MainActivity (V2 embedding)
      - name: Fix MainActivity for V2
        run: |
          mkdir -p android/app/src/main/kotlin/com/expensetracker/app
          cat > android/app/src/main/kotlin/com/expensetracker/app/MainActivity.kt <<'EOF'
          package com.expensetracker.app

          import io.flutter.embedding.android.FlutterActivity

          class MainActivity: FlutterActivity() {
          }
          EOF

      # 9. Flutter pub get
      - name: Flutter Pub Get
        run: flutter pub get

      # 10a. Flutter clean to remove old builds
      - name: Flutter Clean
        run: flutter clean

      # 10b. Build release APK
      - name: Build release APK
        run: flutter build apk --release --verbose

      # 11. Upload APK as artifact
      - name: Upload Release APK
        uses: actions/upload-artifact@v3
        with:
          name: release-apk
          path: build/app/outputs/flutter-apk/app-release.apk
